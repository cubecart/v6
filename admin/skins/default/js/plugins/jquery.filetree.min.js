function in_array(e, b, a) {
    if (a) {
        function d(g, f) {
            return g === f
        }
    } else {
        function d(g, f) {
            return g == f
        }
    }
    for (var c in b) {
        if (d(b[c], e)) {
            return true
        }
    }
    return false
}

function array_search(d, c, a) {
    var a = !!a;
    for (var b in c) {
        if ((a && c[b] === d) || (!a && c[b] == d)) {
            return true
        }
    }
    return false
}
if (jQuery) {
    (function(a) {

        var lang = {
            go:             a("#val_lang_go").length ? a("#val_lang_go").text() : 'Go',
            preview:        a("#val_lang_preview").length ? a("#val_lang_preview").text() : 'Preview',
            main_image:     a("#val_lang_main_image").length ? a("#val_lang_main_image").text() : 'Main Image',
            show_assigned:  a("#val_lang_show_assigned").length ? a("#val_lang_show_assigned").text() : 'Show Assigned Images Only',
            show_all:       a("#val_lang_show_all").length ? a("#val_lang_show_all").text() : 'Show All Images',
            create_folder:  a("#val_lang_folder_create").length ? a("#val_lang_folder_create").text() : 'Create Folder',
            refresh_list:   a("#val_lang_refresh_files").length ? a("#val_lang_refresh_files").text() : 'Refresh File List',
            upload_description: a("#val_lang_upload_destination").length ? a("#val_lang_upload_destination").text() : 'Upload Destination',
            disable:        a("#val_lang_disable").length ? a("#val_lang_disable").text() : 'Disable',
            enable:         a("#val_lang_enable").length ? a("#val_lang_enable").text() : 'Enable'
        }

        var config = {
            skin_folder:    a("#val_skin_folder").length ? a("#val_skin_folder").text() : 'default',
            admin_folder:   a("#val_admin_folder").length ? a("#val_admin_folder").text() : 'admin',
            admin_file:     a("#val_admin_file").length ? a("#val_admin_file").text() : 'admin.php' 
        }

        var image_icon_path  = config.admin_folder + "/skins/" + config.skin_folder + "/images/";

        a.extend(a.fn, {
            fileTree: function(d, c) {
                if (!d) {
                    var d = {}
                }
                if (!c) {
                    var c = function(e) {
                        return
                    }
                }
                if(typeof d.root == 'undefined') {
                    d.root = "/"
                }
                if(typeof d.name == 'undefined') {
                    d.name = "image"
                }
                if(typeof d.group == 'undefined') {
                    d.group = 1
                }
                if(typeof d.script == 'undefined') {
                    d.script = config.admin_file
                }
                if(typeof d.unique == 'undefined') {
                    d.unique = (a(this).hasClass("unique")) ? true : false
                }
                a(this).each(function() {
                    var thisfilepicker = this;  // Remember this specific filepicker
                    function f(h, g) {
                        a(h).addClass("wait");
                        a(".filetree.start").remove();
                        if (a(h).children("ul").length >= 1) {
                            a(h).removeClass("wait").children("ul").slideDown()
                        } else {
                            a.ajaxSetup({
                                complete: function(i, j) {
                                    a(".wait").removeClass("wait")
                                },
                                dataType: "json",
                                global: false
                            });

                            var script_data = {
                                _g: "xml",
                                type: "files",
                                q: "list",
                                dir: g,
                                group: d.group
                            };

                            if($("#val_product_id").length) {
                                script_data.product_id = $("div#val_product_id").text();
                            }
                            if($("#val_cat_id").length) {
                                script_data.cat_id = $("div#val_cat_id").text();
                                d.unique = true;
                            }
                            if($("#val_unique_image").length) {
                                script_data.unique_image = $("div#val_unique_image").text();
                                d.unique = true;
                            }

                            a.getJSON(d.script, script_data, function(j) {
                                a(h).find(".start").html("");
                                var i = document.createElement("ul");
                                a(i).addClass("filetree");

                                if(d.group == '1' && d.root == g) {
                                    var top_level = document.createElement("li");
                                    a(top_level).addClass("directory collapsed");
                                    var top_level_a = document.createElement("a");
                                    a(top_level_a).attr({
                                                    href: "#",
                                                    rel: '/'
                                                }).text('./')
                                    a(i).append(top_level);
                                    a(top_level).append(top_level_a);
                                }
                                
                                a.each(j, function(p, r) {
                                    var k = document.createElement("li");
                                    var m = document.createElement("a");
                                    switch (r.type) {
                                        case "directory":
                                            a(k).addClass("directory collapsed");
                                            a(m).attr({
                                                href: "#",
                                                rel: r.path
                                            }).text(r.name);
                                            break;
                                        case "file":
                                            var q = document.createElement("span");
                                            var o = document.createElement("img");
                                            var l = "0";
                                            var n = r.assigned;

                                            if(r.form_field && r.assigned>0) {
                                                var ff = document.createElement("input");
                                                a(ff).addClass("toggle").attr({
                                                    type: "hidden",
                                                    id: 'imageset_'+r.id,
                                                    rel: r.id,
                                                    name: 'imageset['+r.id+']',
                                                    value: n
                                                });
                                                a(q).append(ff);
                                            }

                                            a(q).addClass("actions");
                                            a(o).addClass("imgtoggle").data({
                                                id: d.name + "_" + r.id,
                                                rel: r.id,
                                                name: d.name + "[" + r.id + "]",
                                                value: n
                                            });
                                            switch (n) {
                                                case "2":
                                                    l = "star";
                                                    break;
                                                default:
                                                    l = n
                                            }
                                            o.src = image_icon_path + l + ".png";
                                            a(o).attr({
                                                rel: "#" + d.name + "_" + r.id
                                            }).addClass("checkbox");
                                            if (d.unique) {
                                                a(o).addClass("unique")
                                            }

                                            a(q).append(o);
                                            a(k).append(q).addClass("file");
                                            a(m).attr({
                                                href: r.path + r.name,
                                                rel: r.path,
                                                title: r.description
                                            }).text(r.file);
                                            if (r.mime.match(/^image/) && r.type_id == '1') {
                                                a(k).addClass("image");
                                                a(m).bind("click", function() {
                                                    a.fn.colorbox({
                                                        href: a(m).attr("href"),
                                                        open: true
                                                    });
                                                    return false
                                                })
                                            }
                                            break
                                    }
                                    a(k).append(m);
                                    a(i).append(k)
                                });

                                if (d.root == g) {
                                    a(h).find("ul:hidden").show()
                                } else {
                                    a(h).find("ul:hidden").slideDown("slow")
                                }
                                if(d.group == '1' && d.root == g) {
                                    var show_all_images = true;
                                    var disp_tog = document.createElement("div");
                                    a(disp_tog).attr('id', 'assigned_toggle');
                                    a(disp_tog).addClass('button');
                                    show_all_images = images_toggle(disp_tog, h, show_all_images); 
                                    a(disp_tog).click(function() {
                                        show_all_images = images_toggle(disp_tog, h, show_all_images);   
                                    });
                                    a(h).append(disp_tog);
                                }
                                a(h).append(i).removeClass("wait");

                                if(!a(thisfilepicker).parent().find('#fm-actions').length) { // Use this specific filepicker
                                    var actions = document.createElement("div");
                                    a(actions).attr('id', 'fm-actions');
                                    a(h).after(actions);

                                    var create_folder = document.createElement("div");
                                    var create_folder_input = document.createElement("input");
                                    var create_folder_btn = document.createElement("button");
                                    a(create_folder_input).attr({
                                                type: 'text',
                                                id: 'fm-icf',
                                                value: ''
                                            });
                                    a(create_folder_btn).attr({
                                                type: 'button',
                                                id: 'fm-bcf' 
                                            }).text(lang.go);

                                    a(create_folder).addClass('fm-create_folder').text(lang.create_folder);
                                    a(create_folder).append(create_folder_input).append(create_folder_btn);

                                    var refresh = document.createElement("div");
                                    var refresh_i = document.createElement("i");
                                    
                                    a(refresh).addClass('fm-refresh');
                                    a(refresh).text(lang.refresh_list);
                                    a(refresh_i).addClass('fa fa-refresh');
                                    a(refresh).prepend(refresh_i);

                                    var selected_folder = document.createElement("div");
                                    var selected_folder_val = document.createElement("span");
                                    a(selected_folder_val).attr('id', 'val_subdir');

                                    a(selected_folder).text(lang.upload_description+' /');
                                    a(selected_folder).append(selected_folder_val);

                                    a(actions).append(create_folder);
                                    a(actions).append(selected_folder);
                                    a(actions).append(refresh);
                                }

                                e(h);
                                a(".loading").hide();

                                var master_image = a("#master_image_preview").attr("src");
                                a("li.image" )
                                  .mouseover(function() {
                                    a(".master_image span").text(lang.preview);
                                    if (a("#master_image_preview").exists()) {
                                        a("#master_image_preview").hide();
                                        var i = a(this).closest(".image").find("a").attr("href");
                                        a("#preview_image img").attr("src", i);
                                        a("#preview_image img").show();
                                    }
                                  })
                                  .mouseout(function() {
                                    a("#master_image_preview").show();
                                    a(".master_image span").text(lang.main_image);
                                    a("#preview_image img").hide();
                                  });
                            })
                        }
                    }

                    function images_toggle(disp_tog , h, show_all_images) {

                        if(show_all_images===true) {
                            a(h).find("li.file").has("img[src$='0.png']").show();
                            a(disp_tog).text(lang.show_assigned);
                            return false;
                        } else if(show_all_images===false) {
                            a(h).find("li.file").has("img[src$='0.png']").hide();
                            a(disp_tog).text(lang.show_all);
                            return true;
                        }
                    }

                    function e(g) {
                        a(g).find("li>a").bind("click", function() {
                            if (a(this).parent().hasClass("directory")) {
                                if(a(this).attr("rel")!=='/') {
                                    if (a(this).parent().hasClass("collapsed")) {
                                        a(this).parent("ul").remove();
                                        f(a(this).parent(), a(this).attr("rel"));
                                        a(this).parent().removeClass("collapsed").addClass("expanded")
                                    } else {
                                        a(this).parent().find("ul").slideUp("slow");
                                        a(this).parent().removeClass("expanded").addClass("collapsed")
                                    }
                                }
                                var destination = a(this).attr("rel");
                                destination = destination.substring(0, destination.length - 1);
                                a('#val_subdir').text(destination);
                            }
                            return false
                        })
                    }
                    a(this).html('<ul class="filetree start"><li class="wait">&nbsp;<li></ul>');
                    f(a(this), escape(d.root))
                })
            }
        });
        a("#content_body").on("click", "#fm-bcf", function() {
            var folder = $("#fm-icf").val();
            var token = $("input[name=token]").val();
            var formData = {fm:{'create-dir':folder},token:token};
            var subdir = '';

            if($("#val_subdir").length) {
                subdir = '&subdir='+$("#val_subdir").text();
            }
            $.ajax({
                url : config.admin_file+"?_g=filemanager&response=token"+subdir,
                type: "POST",
                dataType: "text",
                data : formData,
                success: function(data, textStatus, jqXHR)
                {
                    $("input[name=token]").val(data);
                    $("div#imageset.fm-filelist").fileTree({
                        root: "/",
                        script: "./" + config.admin_file,
                        group: '1',
                        name: 'image',
                        unique: false
                    });
                    $("#fm-icf").val('');
                },
                error: function (jqXHR, textStatus, errorThrown){}
            });


        });
        a("#content_body").on("click", ".fm-refresh", function() {
            $("div#imageset.fm-filelist").fileTree({
                root: "/",
                script: "./" + config.admin_file,
                group: '1',
                name: 'image',
                unique: false
            });
        });
        a("input.toggle:hidden").each(function() {
            var c = (a(this).val() == "1") ? "1" : "0";
            var d = document.createElement("img");
            d.src = image_icon_path + c + ".png";
            if (c == "1") {
                d.alt = d.title = lang.disable
            } else {
                d.alt = d.title = lang.enable
            }
            a(d).addClass("checkbox");
            if (a(this).hasClass("unique")) {
                a(d).addClass("unique")
            }
            a(d).attr("rel", "#" + a(this).attr("id"));
            a(this).after(d)
        }).change(function() {
            switch (a(this).val()) {
                case "1":
                    var d = "1";
                    var e = lang.disable;
                    break;
                case "2":
                    var d = "star";
                    var e = "";
                    break;
                default:
                    var d = "0";
                    var e = lang.enable;
                    break
            }
            var c = "img.checkbox[rel=#" + a(this).attr("id") + "]";
            a(c).attr({
                src: image_icon_path + d + ".png",
                alt: e,
                title: e
            })
        });
        a("#content_body").on("click", "img.imgtoggle", function() {
            var d = a(this).data("id");

            if(a('#'+d).length) {
                a('#'+d).remove();
            }
 
            var g = a(this).hasClass("unique");
            var e = document.createElement("input");
            var c = "0";
            if (g) {
                a(e).addClass("unique")
            }
            a(e).addClass("toggle").attr({
                type: "hidden",
                id: d,
                rel: a(this).data("rel"),
                name: a(this).data("name"),
                value: a(this).data("value")
            }).change(function() {
                switch (a(this).val()) {
                    case "1":
                        c = "1";
                        break;
                    case "2":

                        $('.fm-filelist input.toggle:hidden[value="2"]').val('1');
                        
                        var img = $("img.checkbox[src$='star.png']");
                        if(img.length>0) {
                            img.attr("src", img.attr("src").replace("star", "1"));
                        }
                        
                        c = "star";
                        a(this).val(2);
                        if (a("#master_image_preview").exists()) {
                            var i = a(this).closest(".image").find("a").attr("href");
                            a("#master_image_preview").attr("src", i)
                        }
                        break;
                    default:
                        c = "0";
                        break
                }
                var h = "img.checkbox[rel=#" + d + "]";
                a(h).attr({
                    src: image_icon_path + c + ".png"
                })
            });
            var f = a(this).parent("span.action");
            a(this).before(e);
            a(this).removeClass("imgtoggle").addClass("toggle")
        });
        a("#content_body").on("click", "img.checkbox", function() {
            var e = a(this).attr("rel");
            var c = a(this).parents("div:first").hasClass("fm-filelist");
            var f = a(this).hasClass("unique");
            switch (a(e).val()) {
                case "1":
                    if (f || !c) {
                        var d = "0"
                    } else {
                        a("input[value=2].toggle").each(function() {
                            a("img[rel=" + a(this).attr("rel") + "].checkbox").val("1").change()
                        });
                        var d = "2"
                    }
                    break;
                case "2":
                    var d = "0";
                    break;
                default:
                    if (f) {
                        a("div.unique input.toggle").val("0").change();
                        $("img.checkbox.unique[src$='1.png']").each(function() {
                            var new_src = $(this).attr('src').replace('1.png','0.png');
                            $(this).attr({src: new_src});
                        });
                    }
                    var d = "1";
                    break
            }
            a(e).val(d).change()
        })
    })(jQuery)
};